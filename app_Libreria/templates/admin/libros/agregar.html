{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h1 class="text-verde mb-4">Agregar Nuevo Libro</h1>
    
    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-danger">{{ message }}</div>
    {% endfor %}
    {% endif %}
    
    <!-- Debug: Mostrar editoriales disponibles -->
    <div class="alert alert-info">
        <strong>Editoriales disponibles:</strong> {{ editoriales.count }}
        {% for editorial in editoriales %}
        <br><small>{{ editorial.editorialid }} - {{ editorial.nombre }} - {{ editorial.pais }}</small>
        {% empty %}
        <br><small class="text-danger">No hay editoriales registradas</small>
        {% endfor %}
    </div>
    
    <div class="card">
        <div class="card-body">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">T√≠tulo *</label>
                            <input type="text" class="form-control" name="titulo" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">ISBN *</label>
                            <input type="text" class="form-control" name="isbn" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Autor *</label>
                            <select class="form-control" name="autorid" required>
                                <option value="">Seleccionar autor</option>
                                {% for autor in autores %}
                                <option value="{{ autor.autorid }}">{{ autor.nombre }} {{ autor.apellido }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Editorial *</label>
                            
                            <!-- Campo de b√∫squeda para filtrar -->
                            <input type="text" class="form-control mb-2" id="buscar-editorial" 
                                   placeholder="üîç Buscar editorial por nombre, pa√≠s o email..." 
                                   style="font-size: 14px;">
                            
                            <select class="form-control" name="editorialid" required id="editorial-select" 
                                    size="6" style="height: auto; font-size: 14px; max-height: 200px; overflow-y: auto;">
                                <option value="">Seleccionar editorial</option>
                                {% for editorial in editoriales %}
                                <option value="{{ editorial.editorialid }}" 
                                        data-nombre="{{ editorial.nombre }}"
                                        data-pais="{{ editorial.pais }}"
                                        data-email="{{ editorial.email }}">
                                    {{ editorial.nombre }} - {{ editorial.pais }}
                                    {% if editorial.email %} | {{ editorial.email }}{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            
                            <div class="mt-1">
                                <small class="text-muted" id="contador-editoriales">
                                    Mostrando {{ editoriales.count }} editoriales
                                </small>
                                {% if not editoriales %}
                                <div class="text-danger">
                                    <small>No hay editoriales registradas. 
                                        <a href="{% url 'agregar_editorial' %}">Agregar editorial primero</a>
                                    </small>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">A√±o Publicaci√≥n *</label>
                            <input type="number" class="form-control" name="aniopublicacion" min="1900" max="2030" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">G√©nero *</label>
                            <select class="form-control" name="genero" required>
                                <option value="">Seleccionar g√©nero</option>
                                <option value="FIC">Ficci√≥n</option>
                                <option value="ROM">Romance</option>
                                <option value="TER">Terror</option>
                                <option value="CIE">Ciencia Ficci√≥n</option>
                                <option value="FAN">Fantas√≠a</option>
                                <option value="HIS">Hist√≥rico</option>
                                <option value="BIO">Biograf√≠a</option>
                                <option value="INF">Infantil</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Precio Venta *</label>
                            <input type="number" step="0.01" class="form-control" name="precioventa" min="0" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Stock *</label>
                            <input type="number" class="form-control" name="stock" min="0" required>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Descripci√≥n</label>
                    <textarea class="form-control" name="descripcion" rows="4" placeholder="Descripci√≥n del libro..."></textarea>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Portada</label>
                    <input type="file" class="form-control" name="portada" accept="image/*">
                </div>
                
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-verde">Guardar Libro</button>
                    <a href="{% url 'admin_libros' %}" class="btn btn-secondary">Cancelar</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const editorialSelect = document.getElementById('editorial-select');
    const buscarInput = document.getElementById('buscar-editorial');
    const contador = document.getElementById('contador-editoriales');
    
    // Mostrar informaci√≥n de debug
    console.log('Editoriales cargadas:', {{ editoriales.count }});
    console.log('Opciones en select:', editorialSelect.options.length);
    
    // Funci√≥n para filtrar editoriales
    function filtrarEditoriales() {
        const filtro = buscarInput.value.toLowerCase();
        let visibles = 0;
        
        Array.from(editorialSelect.options).forEach(option => {
            if (option.value === '') {
                option.style.display = 'block'; // Siempre mostrar opci√≥n vac√≠a
                return;
            }
            
            const nombre = option.getAttribute('data-nombre') || '';
            const pais = option.getAttribute('data-pais') || '';
            const email = option.getAttribute('data-email') || '';
            const texto = option.text.toLowerCase();
            
            if (filtro === '' || texto.includes(filtro) || nombre.toLowerCase().includes(filtro) || 
                pais.toLowerCase().includes(filtro) || email.toLowerCase().includes(filtro)) {
                option.style.display = 'block';
                visibles++;
            } else {
                option.style.display = 'none';
            }
        });
        
        // Actualizar contador
        if (contador) {
            contador.textContent = `Mostrando ${visibles} de {{ editoriales.count }} editoriales`;
        }
        
        // Ajustar tama√±o del select basado en resultados visibles
        const resultadosVisibles = Math.min(visibles, 8); // M√°ximo 8 opciones visibles
        editorialSelect.size = resultadosVisibles + 1; // +1 para la opci√≥n vac√≠a
    }
    
    // Event listener para b√∫squeda
    if (buscarInput) {
        buscarInput.addEventListener('input', filtrarEditoriales);
        
        // Limpiar b√∫squeda con Escape
        buscarInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                this.value = '';
                filtrarEditoriales();
            }
        });
    }
    
    // Hacer el select m√°s usable
    if (editorialSelect) {
        // Mostrar m√°s opciones al enfocar
        editorialSelect.addEventListener('focus', function() {
            this.size = Math.min({{ editoriales.count }} + 1, 8); // M√°ximo 8 opciones
        });
        
        // Reducir tama√±o al perder foco (pero mantener selecci√≥n visible)
        editorialSelect.addEventListener('blur', function() {
            setTimeout(() => {
                if (!this.matches(':focus')) {
                    this.size = 1;
                }
            }, 200);
        });
        
        // Reducir tama√±o despu√©s de seleccionar
        editorialSelect.addEventListener('change', function() {
            setTimeout(() => {
                this.size = 1;
            }, 300);
        });
        
        // Navegaci√≥n con teclado mejorada
        editorialSelect.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                e.preventDefault();
                const currentIndex = this.selectedIndex;
                let newIndex = currentIndex;
                
                if (e.key === 'ArrowDown') {
                    newIndex = Math.min(currentIndex + 1, this.options.length - 1);
                } else if (e.key === 'ArrowUp') {
                    newIndex = Math.max(currentIndex - 1, 0);
                }
                
                // Saltar opciones ocultas
                while (newIndex >= 0 && newIndex < this.options.length && 
                       this.options[newIndex].style.display === 'none') {
                    if (e.key === 'ArrowDown') {
                        newIndex++;
                    } else {
                        newIndex--;
                    }
                }
                
                if (newIndex >= 0 && newIndex < this.options.length) {
                    this.selectedIndex = newIndex;
                }
            }
        });
    }
    
    // Inicializar filtro
    filtrarEditoriales();
    
    // Informaci√≥n de ayuda
    console.log('üí° Tips de uso:');
    console.log('   - Usa el campo de b√∫squeda para filtrar editoriales');
    console.log('   - Presiona ESC para limpiar la b√∫squeda');
    console.log('   - Usa las flechas ‚Üë‚Üì para navegar con teclado');
});
</script>

<style>
/* Estilos para el select con scroll */
#editorial-select {
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    transition: all 0.3s ease;
}

#editorial-select:focus {
    border-color: #2e8b57;
    box-shadow: 0 0 0 0.2rem rgba(46, 139, 87, 0.25);
}

/* Estilo para las opciones del select */
#editorial-select option {
    padding: 8px 12px;
    border-bottom: 1px solid #f8f9fa;
    font-size: 14px;
    cursor: pointer;
}

#editorial-select option:hover {
    background-color: #e9ecef !important;
}

#editorial-select option:checked {
    background-color: #2e8b57 !important;
    color: white !important;
}

/* Estilo para el campo de b√∫squeda */
#buscar-editorial {
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
}

#buscar-editorial:focus {
    border-color: #2e8b57;
    box-shadow: 0 0 0 0.2rem rgba(46, 139, 87, 0.25);
}

/* Contador de editoriales */
#contador-editoriales {
    font-size: 12px;
    color: #6c757d;
}

/* Responsive */
@media (max-width: 768px) {
    #editorial-select {
        font-size: 16px; /* Previene zoom en iOS */
    }
}
</style>
{% endblock %}